{% extends 'base.html' %}
{% load static %}

{% block title %}Gestión de Métodos de Cobro - Global Exchange{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <!-- Encabezado -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="fas fa-credit-card me-2"></i>
                    Gestión de Métodos de   Cobro
                </h2>
            </div>

            <!-- Estadísticas -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h3 class="mb-0">{{ total_metodos }}</h3>
                                    <p class="mb-0">Total Métodos</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-credit-card fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h3 class="mb-0">{{ metodos_activos }}</h3>
                                    <p class="mb-0">Activos</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-check-circle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-danger text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h3 class="mb-0">{{ metodos_inactivos }}</h3>
                                    <p class="mb-0">Inactivos</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-times-circle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabla de métodos de   Cobro -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        Lista de Métodos de   Cobro
                    </h5>
                </div>
                <div class="card-body">
                    {% if metodos_pago %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <!--<th>ID</th>-->
                                        <th>Nombre</th>
                                        <!--<th>Comisión</th>-->
                                        <th>Estado</th>
                                        <th>Fecha Creación</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for metodo in metodos_pago %}
                                        <tr id="metodo-{{ metodo.id }}">
                                            <!--<td>{{ metodo.id }}</td>-->
                                            <td>
                                                <strong>{{ metodo.nombre }}</strong>
                                            </td>
                                            <!--<td>
                                                {{ metodo.porcentaje_comision|default:"Sin descripción"|truncatechars:50 }}
                                            </td>-->
                                            <td>
                                                <span class="badge {% if metodo.esta_activo %}bg-success{% else %}bg-danger{% endif %}">
                                                    {% if metodo.esta_activo %}
                                                        <i class="fas fa-check-circle me-1"></i>Activo
                                                    {% else %}
                                                        <i class="fas fa-times-circle me-1"></i>Inactivo
                                                    {% endif %}
                                                </span>
                                            </td>
                                            <td>
                                                {{ metodo.fecha_creacion|date:"d/m/Y H:i" }}
                                            </td>
                                            <td>
                                                <button
                                                    type="button"
                                                    class="btn btn-sm {% if metodo.esta_activo %}btn-warning{% else %}btn-success{% endif %} toggle-metodo"
                                                    data-metodo-id="{{ metodo.id }}"
                                                    data-metodo-nombre="{{ metodo.nombre }}"
                                                    title="{% if metodo.esta_activo %}Deshabilitar{% else %}Habilitar{% endif %} método de Cobro">
                                                    <i class="fas {% if metodo.esta_activo %}fa-eye-slash{% else %}fa-eye{% endif %} me-1"></i>
                                                    {% if metodo.esta_activo %}Deshabilitar{% else %}Habilitar{% endif %}
                                                </button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-credit-card fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No hay métodos de Cobro registrados</h5>
                            <p class="text-muted">Los métodos de   Cobro se configuran desde el panel de administración.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Manejar toggle de métodos de Cobro
    document.querySelectorAll('.toggle-metodo').forEach(function(boton) {
        boton.addEventListener('click', function() {
            const metodoId = this.dataset.metodoId;
            const metodoNombre = this.dataset.metodoNombre;
            const accionActual = this.textContent.trim();

            // Confirmar acción
            const confirmacion = confirm(
                `¿Está seguro que desea ${accionActual.toLowerCase()} el método de Cobro "${metodoNombre}"?`
            );

            if (!confirmacion) {
                return;
            }

            // Deshabilitar botón temporalmente
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Procesando...';

            // Realizar solicitud AJAX
            fetch(`{% url 'pagos:toggle_metodo_cobro' 0 %}`.replace('0', metodoId), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                                  document.querySelector('meta[name=csrf-token]')?.getAttribute('content'),
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    this.disabled = false;

                    // Actualizar interfaz
                    this.className = `btn btn-sm ${data.clase_boton} toggle-metodo`;
                    this.innerHTML = `<i class="fas ${data.icono} me-1"></i>${data.accion_contraria}`;

                    // Actualizar badge de estado
                    const fila = document.getElementById(`metodo-${metodoId}`);
                    const badge = fila.querySelector('.badge');
                    if (data.nuevo_estado) {
                        badge.className = 'badge bg-success';
                        badge.textContent = 'Activo';
                    } else {
                        badge.className = 'badge bg-danger';
                        badge.textContent = 'Inactivo';
                    }

                    // Mostrar mensaje de éxito
                    mostrarMensaje('success', data.mensaje);
                } else {
                    mostrarMensaje('danger', 'Error al actualizar el método de Cobro');
                    this.disabled = false;
                    this.innerHTML = `<i class="fas ${data.icono} me-1"></i>${accionActual}`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                mostrarMensaje('danger', 'Error de conexión');
                this.disabled = false;
                this.innerHTML = `<i class="fas fa-credit-card me-1"></i>${accionActual}`;
            });
        });
    });

    function mostrarMensaje(tipo, mensaje) {
        // Eliminar mensajes anteriores
        const mensajesExistentes = document.querySelectorAll('.container.mt-3 .alert');
        mensajesExistentes.forEach(msg => msg.remove());

        // Crear el nuevo mensaje con la estructura que usas
        const contenedorMensaje = document.createElement('div');
        contenedorMensaje.className = 'container mt-3';

        const alerta = document.createElement('div');
        alerta.className = `alert alert-${tipo} alert-dismissible fade show`;
        alerta.setAttribute('role', 'alert');
        alerta.innerHTML = `
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        contenedorMensaje.appendChild(alerta);

        // Insertar al inicio del body o después del nav
        const contenidoPrincipal = document.querySelector('main') || document.body;
        contenidoPrincipal.insertBefore(contenedorMensaje, contenidoPrincipal.firstChild);

        // Auto-ocultar después de 5 segundos
        setTimeout(() => {
            if (contenedorMensaje.parentNode) {
                contenedorMensaje.remove();
            }
        }, 5000);
    }
});
</script>
{% endblock %}