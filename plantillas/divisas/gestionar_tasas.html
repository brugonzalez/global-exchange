{% extends 'base.html' %}
{% load humanize %}
{% load l10n %}

{% block title %}Gestión de Tasas - Global Exchange{% endblock %}

{% block content %}

<style>
    .tasa-header {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 30px;
    }
</style>
<div class="container mt-4">
    <!-- Encabezado -->
    <!-- <div class="row mb-4"> -->
    <div class="tasa-header mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2>
                    <i class="fas fa-cog me-2"></i>
                    Gestión de Tasas de Cambio
                </h2>
                <div>
                    <a href="{% url 'divisas:panel_de_control' %}" class="btn btn-outline-light">
                        <i class="fas fa-home me-2"></i>Volver al Inicio
                    </a>
                </div>
            </div>
            <p class="mb-0">Administre el valor de compra y venta de las monedas</p>
        </div>
    </div>

    <!-- Tarjetas de Estadísticas -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-primary">
                <div class="card-body text-center">
                    <i class="fas fa-coins text-primary mb-2" style="font-size: 2rem;"></i>
                    <h4 class="text-primary">{{ total_monedas }}</h4>
                    <p class="mb-0">Monedas Activas</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-success">
                <div class="card-body text-center">
                    <i class="fas fa-chart-line text-success mb-2" style="font-size: 2rem;"></i>
                    <h4 class="text-success">{{ tasas_activas }}</h4>
                    <p class="mb-0">Tasas Activas</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-info">
                <div class="card-body text-center">
                    <i class="fas fa-globe text-info mb-2" style="font-size: 2rem;"></i>
                    <h4 class="text-info">{{ moneda_base.codigo|default:"N/A" }}</h4>
                    <p class="mb-0">Moneda Base</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-warning">
                <div class="card-body text-center">
                    <i class="fas fa-clock text-warning mb-2" style="font-size: 2rem;"></i>
                    <h4 class="text-warning" id="horaUltimaActualizacion">
                        {% if ultima_actualizacion %}
                            {{ ultima_actualizacion|date:"d/m/Y H:i" }}
                        {% else %}
                            --:--
                        {% endif %}
                    </h4>
                    <p class="mb-0">Última Actualización</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row justify-content-center mb-5">
        <div class="col-lg-10 col-md-12">
            <!-- Filtro de búsqueda por nombre de moneda -->
            <div class="mb-3">
                <div class="position-relative">
                    <i class="fa-solid fa-magnifying-glass text-secondary search-icon"></i>
                    <input
                    type="text"
                    id="filtroMoneda"
                    class="form-control form-control-lg rounded-pill search-input ps-5 pe-5"
                    placeholder="Filtrar por nombre de moneda…">
                    <button
                    type="button"
                    id="clearFiltro"
                    class="btn btn-link text-muted position-absolute top-50 end-0 translate-middle-y me-3 p-0 d-none"
                    aria-label="Limpiar">
                    <i class="fa-solid fa-xmark fs-5"></i>
                    </button>
                </div>

                <div class="form-text ms-2">Ej.: dólar, euro, peso…</div>
                </div>


            <div class="accordion justify-content-center" id="accordionDivisas">

                {% for info_tasa in datos_tasas %}
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading-{{ info_tasa.moneda.id }}">
                            <button class="accordion-button collapsed d-flex align-items-center" 
                                    type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#collapse-{{ info_tasa.moneda.id }}" 
                                    aria-expanded="false" aria-controls="collapse-{{ info_tasa.moneda.id }}">

                                {% if info_tasa.moneda.pais %}
                                    <img src="{{ info_tasa.moneda.pais.flag }}" 
                                        alt="{{ info_tasa.moneda.pais.name }}" 
                                        class="me-2" width="20" height="14">
                                {% else %}
                                    <div class="me-2 d-inline-block" style="width: 20px; height: 14px; background-color: #f8f9fa; border: 1px solid #dee2e6;"></div>
                                {% endif %}

                                <span class="me-3 fw-bold text-center" style="width: 20px; ">
                                    {{ info_tasa.moneda.simbolo }}
                                </span>

                                <span class="me-3 fw-bold" style="width: 40px;">
                                    {{ info_tasa.moneda.codigo }}
                                </span>

                                <span class="me-3 text-muted" style="width: 350px;">
                                    {{ info_tasa.moneda.nombre }}
                                </span>

                                {% if info_tasa.moneda.es_moneda_base %}
                                    <span class="badge bg-primary ms-2">Base</span>
                                {% else %}
                                    <span class="me-3 text-info precio-base-wrap" style="width: 200px;">
                                        Precio Base:
                                        <span class="badge bg-info precio-base-badge">
                                            {{ info_tasa.precio_actual|floatformat:0|intcomma }} PYG
                                        </span>
                                    </span>

                                    <small class="text-muted meta-actualizacion">
                                        <i class="fas fa-clock me-1"></i>
                                        Actualizado:
                                        <span class="fecha-actualizacion">
                                            {{ info_tasa.fecha_actualizacion|date:"d/m/Y H:i" }}
                                        </span>
                                        <br>
                                        <small class="text-muted">
                                            <i class="fas fa-user me-1"></i>
                                            Fuente:
                                            <span class="fuente-actualizacion">
                                                {% if info_tasa.actualizado_por %}
                                                    por {{ info_tasa.actualizado_por.nombre_completo|default:info_tasa.actualizado_por.username }}
                                                {% endif %}
                                            </span>
                                        </small>
                                    </small>
                                {% endif %}

                            </button>
                        </h2>
                        
                        <div id="collapse-{{ info_tasa.moneda.id }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ info_tasa.moneda.id }}" data-bs-parent="#accordionDivisas">
                            <div class="accordion-body">

                                <!-- Encabezado visual de la moneda -->
                                <div class="d-flex align-items-center justify-content-between mb-3 p-3 rounded-3 border bg-body-tertiary shadow-sm">
                                    <div class="d-flex align-items-center gap-2">
                                        <i class="fas fa-coins text-warning-emphasis"></i>
                                        <h6 class="mb-0 fw-semibold text-body-emphasis">{{ info_tasa.moneda.nombre }} <span class="text-muted">({{ info_tasa.moneda.codigo }})</span></h6>
                                    </div>
                                    <span class="badge text-bg-light border">
                                        <i class="fas fa-hashtag me-1"></i>ID: {{ info_tasa.moneda.id }}
                                    </span>
                                </div>

                                {# ==== PRECIO BASE ==== #}
                                <form class="formulario-actualizar-tasa" data-currency-id="{{ info_tasa.moneda.id }}" method="post" autocomplete="off">
                                    {% csrf_token %}
                                    <div class="card border-0 shadow-sm mb-3">
                                        <div class="card-header bg-primary-subtle border-0 rounded-top-3">
                                            <div class="d-flex align-items-center gap-2">
                                                <i class="fas fa-edit text-primary"></i>
                                                <strong class="mb-0 text-primary-emphasis">Precio base</strong>
                                            </div>
                                        </div>

                                        <div class="card-body">
                                            <div class="row g-3 align-items-end">
                                                <div class="col-12 col-md-8">
                                                    <label for="precio-base-{{ info_tasa.moneda.id }}" class="form-label mb-1">Monto</label>
                                                    <div class="input-group input-group-sm">
                                                        <input
                                                            id="precio-base-{{ info_tasa.moneda.id }}"
                                                            name="precio_base"
                                                            type="number" inputmode="numeric"
                                                            class="form-control text-end"
                                                            step="1" min="0" placeholder="0"
                                                            value="{{ info_tasa.precio_actual|unlocalize|floatformat:0 }}"
                                                            required
                                                        >
                                                        <span class="input-group-text">PYG</span>
                                                    </div>
                                                    <div class="form-text mt-1">
                                                        Enteros (sin puntos). Se guarda como precio base.
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Divider + acciones unificados -->
                                            <div class="border-top pt-3 mt-3 d-grid d-md-flex justify-content-md-end gap-2">
                                                <button type="submit" class="btn btn-primary btn-sm">
                                                    <i class="fas fa-save me-1"></i> Actualizar precio
                                                </button>
                                            </div>

                                            <!-- Divider + acciones unificados -->
                                            <div class="border-top pt-3 mt-3 d-grid d-md-flex justify-content-md-end gap-2">
                                                <button type="submit" class="btn btn-primary btn-sm">
                                                    <i class="fas fa-save me-1"></i> Actualizar precio
                                                </button>
                                            </div>
                                        </div>

                                        <div class="card-footer bg-body-tertiary border-0 rounded-bottom-3 small text-muted">
                                            <i class="fas fa-info-circle me-1"></i>Este valor sirve de referencia para calcular compra/venta por categoría.
                                        </div>
                                    </div>
                                </form>

                                {# ==== COMISIONES ==== #}
                                <form class="formulario-actualizar-moneda" data-currency-id="{{ info_tasa.moneda.id }}" method="post" autocomplete="off">
                                    {% csrf_token %}
                                    <div class="card border-0 shadow-sm mb-3">
                                        <div class="card-header bg-success-subtle border-0 rounded-top-3">
                                            <div class="d-flex align-items-center gap-2">
                                                <i class="fas fa-percent text-success"></i>
                                                <strong class="mb-0 text-success-emphasis">Comisiones</strong>
                                            </div>
                                        </div>

                                        <div class="card-body">
                                            <div class="row g-3">
                                                <div class="col-12 col-md-6">
                                                    <label for="comision-compra-{{ info_tasa.moneda.id }}" class="form-label mb-1">Comisión de compra</label>
                                                    <div class="input-group input-group-sm">
                                                        <input
                                                            id="comision-compra-{{ info_tasa.moneda.id }}"
                                                            name="comision_compra"
                                                            type="number" inputmode="numeric"
                                                            class="form-control text-end"
                                                            step="1" min="0" placeholder="0"
                                                            value="{{ info_tasa.moneda.comision_compra|unlocalize|floatformat:0 }}"
                                                            required
                                                        >
                                                        <span class="input-group-text">PYG</span>
                                                    </div>
                                                    <div class="form-text mt-1">Enteros. Se aplica al comprar esta divisa.</div>
                                                </div>

                                                <div class="col-12 col-md-6">
                                                    <label for="comision-venta-{{ info_tasa.moneda.id }}" class="form-label mb-1">Comisión de venta</label>
                                                    <div class="input-group input-group-sm">
                                                        <input
                                                            id="comision-venta-{{ info_tasa.moneda.id }}"
                                                            name="comision_venta"
                                                            type="number" inputmode="numeric"
                                                            class="form-control text-end"
                                                            step="1" min="0" placeholder="0"
                                                            value="{{ info_tasa.moneda.comision_venta|unlocalize|floatformat:0 }}"
                                                            required
                                                        >
                                                        <span class="input-group-text">PYG</span>
                                                    </div>
                                                    <div class="form-text mt-1">Enteros. Se aplica cuando vendés esta divisa.</div>
                                                </div>
                                            </div>

                                            <!-- Divider + acciones unificados -->
                                            <div class="border-top pt-3 mt-3 d-grid d-md-flex justify-content-md-end gap-2">
                                                <button type="submit" class="btn btn-success btn-sm">
                                                    <i class="fas fa-save me-1"></i> Guardar cambios
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </form>

                                <!-- Tasas activas -->
                                <div class="card border-0 shadow-sm">
                                    <div class="card-header bg-info-subtle border-0 rounded-top-3">
                                        <div class="d-flex align-items-center gap-2">
                                            <i class="fas fa-chart-line text-info"></i>
                                            <strong class="mb-0 text-info-emphasis">Tasas activas</strong>
                                        </div>
                                    </div>

                                    <div class="card-body p-0">
                                        <div class="table-responsive">
                                            <table class="table table-sm table-hover align-middle mb-0">
                                                <colgroup>
                                                    <col style="width: 50%">
                                                    <col style="width: 25%">
                                                    <col style="width: 25%">
                                                </colgroup>
                                                <thead class="table-light">
                                                    <tr>
                                                        <th class="text-muted">Categoría</th>
                                                        <th class="text-end">
                                                            <span class="d-inline-flex align-items-center gap-1">
                                                                <i class="fas fa-arrow-down text-success"></i> Compra
                                                            </span>
                                                        </th>
                                                        <th class="text-end">
                                                            <span class="d-inline-flex align-items-center gap-1">
                                                                <i class="fas fa-arrow-up text-danger"></i> Venta
                                                            </span>
                                                        </th>
                                                    </tr>
                                                </thead>
                                                <tbody class="table-group-divider js-tasas-body" data-moneda-id="{{ info_tasa.moneda.id }}">
                                                    {% for tasa in info_tasa.tasas_actuales %}
                                                    <tr>
                                                        <td class="text-nowrap">
                                                            <span class="badge rounded-pill bg-secondary-subtle text-secondary-emphasis border">
                                                                {{ tasa.categoria_cliente.nombre }}
                                                            </span>
                                                        </td>
                                                        <td class="text-end text-success fw-semibold">
                                                            {{ tasa.tasa_compra|floatformat:0|intcomma }} PYG
                                                        </td>
                                                        <td class="text-end text-danger fw-semibold">
                                                            {{ tasa.tasa_venta|floatformat:0|intcomma }} PYG
                                                        </td>
                                                    </tr>
                                                    {% empty %}
                                                    <tr>
                                                        <td colspan="3" class="text-center text-muted py-4">Sin tasas activas</td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <div class="card-footer bg-body-tertiary border-0 rounded-bottom-3 small text-muted">
                                        <i class="far fa-clock me-1"></i>Los valores mostrados corresponden a las categorías actualmente vigentes.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Contenedor de Alertas de Éxito/Error -->
<div id="contenedorAlertas" style="position: fixed; top: 20px; right: 20px; z-index: 1050; max-width: 400px;"></div>

<!-- Superposición de Carga -->
<div id="superposicionCarga" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000;">
    <div class="d-flex justify-content-center align-items-center h-100">
        <div class="text-center text-white">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2">Actualizando tasas...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Estilos del buscador “bonito” */
.search-icon{
  position:absolute;
  left:14px;
  top:50%;
  transform:translateY(-50%);
  pointer-events:none;
}
.search-input{
  transition: box-shadow .2s, border-color .2s;
}
.search-input::placeholder{
  color:#9aa0a6;
}
.search-input:focus{
  box-shadow:0 0 0 .25rem rgba(13,110,253,.15);
  border-color:#86b7fe;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // No tomar el token global, se tomará del formulario en cada submit
    // La hora de última actualización se actualiza por AJAX

    // AJAX para formulario de precio base
    document.querySelectorAll('.formulario-actualizar-tasa').forEach(formulario => {
        if (formulario.querySelector('input[name="precio_base"]')) {
            formulario.addEventListener('submit', function(e) {
                e.preventDefault();
                const idMoneda = this.dataset.currencyId;
                const precioBase = this.querySelector('input[name="precio_base"]').value;
                if (!precioBase || isNaN(precioBase) || parseFloat(precioBase) <= 0) {
                    mostrarAlerta('error', 'Por favor ingrese un precio base válido (> 0)');
                    return;
                }
                actualizarPrecioBase(idMoneda, precioBase, this);
            });
        }
    });

    // AJAX para formulario de comisiones
    document.querySelectorAll('.formulario-actualizar-moneda').forEach(formulario => {
        formulario.addEventListener('submit', function(e) {
            e.preventDefault();
            const idMoneda = this.dataset.currencyId;
            const comisionCompra = this.querySelector('input[name="comision_compra"]').value;
            const comisionVenta = this.querySelector('input[name="comision_venta"]').value;
            if (!comisionCompra || isNaN(comisionCompra) || parseFloat(comisionCompra) < 0) {
                mostrarAlerta('error', 'Ingrese una comisión de compra válida (>= 0)');
                return;
            }
            if (!comisionVenta || isNaN(comisionVenta) || parseFloat(comisionVenta) < 0) {
                mostrarAlerta('error', 'Ingrese una comisión de venta válida (>= 0)');
                return;
            }
            actualizarComisiones(idMoneda, comisionCompra, comisionVenta, this);
        });
    });

    // Filtro de búsqueda por nombre de moneda
    const filtroInput = document.getElementById('filtroMoneda');
    if (filtroInput) {
        filtroInput.addEventListener('input', function() {
            const filtro = this.value.trim().toLowerCase();
            document.querySelectorAll('#accordionDivisas .accordion-item').forEach(item => {
                const nombre = item.querySelector('.accordion-button .me-3.text-muted');
                if (!nombre) return;
                const texto = nombre.textContent.trim().toLowerCase();
                if (texto.includes(filtro)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        });
        // Mostrar/ocultar botón limpiar
        const btnClear = document.getElementById('clearFiltro');
        filtroInput.addEventListener('input', () => {
            btnClear.classList.toggle('d-none', !filtroInput.value);
        });
        btnClear.addEventListener('click', () => {
            filtroInput.value = '';
            filtroInput.dispatchEvent(new Event('input'));
            filtroInput.focus();
        });
    }

    function actualizarComisiones(idMoneda, comisionCompra, comisionVenta, formulario) {
        const botonEnviar = formulario.querySelector('button[type="submit"]');
        const textoOriginal = botonEnviar.innerHTML;
        botonEnviar.disabled = true;
        botonEnviar.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Guardando...';
        const tokenCSRF = formulario.querySelector('[name=csrfmiddlewaretoken]').value;
        fetch('{% url "divisas:actualizar_comisiones" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': tokenCSRF,
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
            },
            body: new URLSearchParams({
                'moneda_id': idMoneda,
                'comision_compra': comisionCompra,
                'comision_venta': comisionVenta
            }),
            credentials: 'same-origin'
        })
        .then(async (res) => {
            const ct = res.headers.get('content-type') || '';
            if (!res.ok) {
                const text = await res.text();
                throw new Error(`HTTP ${res.status}: ${text.slice(0,200)}`);
            }
            if (ct.includes('application/json')) {
                return res.json();
            }
            const text = await res.text();
            throw new Error('Respuesta no-JSON:\n' + text.slice(0,200));
        })
        .then((data) => {
            if (data.success) {
                mostrarAlerta('success', data.message || 'Comisiones actualizadas correctamente');
                const inputCompra = formulario.querySelector('input[name="comision_compra"]');
                if (inputCompra && data.comision_compra_raw != null) {
                    inputCompra.value = Math.trunc(data.comision_compra_raw);
                }
                const inputVenta = formulario.querySelector('input[name="comision_venta"]');
                if (inputVenta && data.comision_venta_raw != null) {
                    inputVenta.value = Math.trunc(data.comision_venta_raw);
                }
                const item = formulario.closest('.accordion-item');
                const tbody = item.querySelector('.js-tasas-body');
                if (tbody && data.tasas_tbody_html) {
                    tbody.innerHTML = data.tasas_tbody_html;
                }
                // Actualizar hora global de última actualización si viene en la respuesta
                if (data.ultima_actualizacion_str) {
                    const horaGlobal = document.getElementById('horaUltimaActualizacion');
                    if (horaGlobal) horaGlobal.textContent = data.ultima_actualizacion_str;
                }
                return;
            }
            mostrarAlerta('error', (data.message || data.error) || 'Error al actualizar comisiones');
        })
        .catch((err) => {
            console.error(err);
            mostrarAlerta('error', 'Error de conexión o respuesta inválida del servidor');
        })
        .finally(() => {
            botonEnviar.disabled = false;
            botonEnviar.innerHTML = textoOriginal;
        });
    }

    function actualizarPrecioBase(idMoneda, precioBase, formulario) {
        const botonEnviar = formulario.querySelector('button[type="submit"]');
        const textoOriginal = botonEnviar.innerHTML;
        botonEnviar.disabled = true;
        botonEnviar.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Actualizando...';
        const tokenCSRF = formulario.querySelector('[name=csrfmiddlewaretoken]').value;
        fetch('{% url "divisas:actualizar_precio_base" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': tokenCSRF,
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json'
            },
            body: new URLSearchParams({
                'moneda_id': idMoneda,
                'precio_base': precioBase
            }),
            credentials: 'same-origin'
        })
        .then(async (res) => {
            const ct = res.headers.get('content-type') || '';
            if (!res.ok) {
                const text = await res.text();
                throw new Error(`HTTP ${res.status}: ${text.slice(0,200)}`);
            }
            if (ct.includes('application/json')) {
                return res.json();
            }
            const text = await res.text();
            throw new Error('Respuesta no-JSON:\n' + text.slice(0,200));
        })
        .then((data) => {
            if (data.success) {
                mostrarAlerta('success', data.message || 'Precio base actualizado correctamente');
                const item = formulario.closest('.accordion-item');
                const badge = item.querySelector('.precio-base-badge');
                if (badge && data.precio_base_html) {
                    badge.textContent = data.precio_base_html;
                }
                const fecha = item.querySelector('.fecha-actualizacion');
                if (fecha && data.fecha_actualizacion_str) {
                    fecha.textContent = data.fecha_actualizacion_str;
                }
                const usuario = item.querySelector('.fuente-actualizacion');
                if (usuario && data.fuente_actualizacion_str !== undefined) {
                    usuario.textContent = data.fuente_actualizacion_str;
                }
                const tbody = item.querySelector('.js-tasas-body');
                if (tbody && data.tasas_tbody_html) {
                    tbody.innerHTML = data.tasas_tbody_html;
                }
                const input = formulario.querySelector('input[name="precio_base"]');
                if (input && data.precio_base_raw != null) {
                    input.value = Math.trunc(data.precio_base_raw);
                }
                // Actualizar hora global de última actualización si viene en la respuesta
                if (data.ultima_actualizacion_str) {
                    const horaGlobal = document.getElementById('horaUltimaActualizacion');
                    if (horaGlobal) horaGlobal.textContent = data.ultima_actualizacion_str;
                }
                return;
            }
            mostrarAlerta('error', (data.message || data.error) || 'Error al actualizar el precio base');
        })
        .catch((err) => {
            console.error(err);
            mostrarAlerta('error', 'Error de conexión o respuesta inválida del servidor');
        })
        .finally(() => {
            botonEnviar.disabled = false;
            botonEnviar.innerHTML = textoOriginal;
        });
    };

    function mostrarAlerta(tipo, mensaje) {
        const contenedorAlertas = document.getElementById('contenedorAlertas');
        const claseAlerta = tipo === 'success' ? 'alert-success' : 'alert-danger';
        const icono = tipo === 'success' ? 'check-circle' : 'exclamation-triangle';
        const alerta = document.createElement('div');
        alerta.className = `alert ${claseAlerta} alert-dismissible fade show`;
        alerta.innerHTML = `
            <i class="fas fa-${icono} me-2"></i>
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        contenedorAlertas.appendChild(alerta);
        setTimeout(() => {
            if (alerta.parentNode) alerta.remove();
        }, 5000);
    }
    
    function actualizarHoraUltimaActualizacion() {
        const ahora = new Date();
        const cadenaTiempo = ahora.toLocaleTimeString('es-ES', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        document.getElementById('horaUltimaActualizacion').textContent = cadenaTiempo;
    }
});
</script>
{% endblock %}