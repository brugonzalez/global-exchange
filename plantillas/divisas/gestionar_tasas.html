{% extends 'base.html' %}
{% load humanize %}
{% load l10n %}

{% block title %}Gestión de Tasas - Global Exchange{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Encabezado -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2>
                    <i class="fas fa-cog me-2"></i>
                    Gestión de Tasas de Cambio
                </h2>
                <div>
                    <a href="{% url 'divisas:panel_de_control' %}" class="btn btn-outline-primary">
                        <i class="fas fa-home me-2"></i>Volver al Inicio
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Tarjetas de Estadísticas -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-primary">
                <div class="card-body text-center">
                    <i class="fas fa-coins text-primary mb-2" style="font-size: 2rem;"></i>
                    <h4 class="text-primary">{{ total_monedas }}</h4>
                    <p class="mb-0">Monedas Activas</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-success">
                <div class="card-body text-center">
                    <i class="fas fa-chart-line text-success mb-2" style="font-size: 2rem;"></i>
                    <h4 class="text-success">{{ tasas_activas }}</h4>
                    <p class="mb-0">Tasas Activas</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-info">
                <div class="card-body text-center">
                    <i class="fas fa-globe text-info mb-2" style="font-size: 2rem;"></i>
                    <h4 class="text-info">{{ moneda_base.codigo|default:"N/A" }}</h4>
                    <p class="mb-0">Moneda Base</p>
                </div>
            </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-warning">
                <div class="card-body text-center">
                    <i class="fas fa-clock text-warning mb-2" style="font-size: 2rem;"></i>
                    <h4 class="text-warning" id="horaUltimaActualizacion">--:--</h4>
                    <p class="mb-0">Última Actualización</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row justify-content-center mb-5">
        <div class="col-lg-10 col-md-12">
            <div class="accordion justify-content-center" id="accordionDivisas">
                {% for info_tasa in datos_tasas %}
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading-{{ info_tasa.moneda.id }}">
                            <button class="accordion-button collapsed d-flex align-items-center" 
                                    type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#collapse-{{ info_tasa.moneda.id }}" 
                                    aria-expanded="false" aria-controls="collapse-{{ info_tasa.moneda.id }}">

                                <img src="{{ info_tasa.moneda.pais.flag }}" 
                                    alt="{{ info_tasa.moneda.pais.name }}" 
                                    class="me-2" width="20" height="14">

                                <span class="me-3 fw-bold text-center" style="width: 20px; ">
                                    {{ info_tasa.moneda.simbolo }}
                                </span>

                                <span class="me-3 fw-bold" style="width: 40px;">
                                    {{ info_tasa.moneda.codigo }}
                                </span>

                                <span class="me-3 text-muted" style="width: 350px;">
                                    {{ info_tasa.moneda.nombre }}
                                </span>

                                {% if info_tasa.moneda.es_moneda_base %}
                                    <span class="badge bg-primary ms-2">Base</span>
                                {% else %}
                                    <span class="me-3 text-info" style="width: 200px;">
                                        Precio Base:
                                        <span class="badge bg-info">{{ info_tasa.precio_actual|floatformat:0|intcomma }} PYG</span>
                                    </span>

                                    <small class="text-muted">
                                            <i class="fas fa-clock me-1"></i>
                                            Actualizado: {{ info_tasa.fecha_actualizacion|date:"d/m/Y H:i"   }}
                                            <br>
                                            <small class="text-muted">
                                                <i class="fas fa-user me-1"></i>
                                                Fuente: 
                                                {% if info_tasa.actualizado_por %}
                                                    por {{ info_tasa.actualizado_por.nombre_completo|default:info_tasa.actualizado_por.username }}
                                                {% endif %}
                                            </small>
                                    </small>
                                {% endif %}
                            </button>
                        </h2>
                        <div id="collapse-{{ info_tasa.moneda.id }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ info_tasa.moneda.id }}" data-bs-parent="#accordionDivisas">
                            <div class="accordion-body">                               
                                {# ==== PRECIO BASE ==== #}
                                <form class="formulario-actualizar-tasa" data-currency-id="{{ info_tasa.moneda.id }}" method="post" autocomplete="off">
                                    {% csrf_token %}
                                    <div class="border rounded-3 p-3 mb-3">
                                        <div class="d-flex align-items-center gap-2 mb-2">
                                            <i class="fas fa-edit text-primary"></i>
                                            <strong class="mb-0">Precio base</strong>
                                        </div>
                                        <div class="row g-2 align-items-end">
                                            <div class="col-12 col-md-8">
                                                <label for="precio-base-{{ info_tasa.moneda.id }}" class="form-label mb-1">Monto</label>
                                                <div class="input-group input-group-sm">
                                                    <input
                                                        id="precio-base-{{ info_tasa.moneda.id }}"
                                                        name="precio_base"
                                                        type="number" inputmode="numeric"
                                                        class="form-control text-end"
                                                        step="1" min="0" placeholder="0"
                                                        value="{{ info_tasa.precio_actual|unlocalize|floatformat:0 }}"
                                                        required
                                                    >
                                                    <span class="input-group-text">PYG</span>
                                                </div>
                                            </div>

                                            <div class="form-text">Enteros (sin puntos). Se guarda como precio base.</div>

                                            <div class="col-12 col-md-4 d-grid">
                                                <button type="submit" class="btn btn-primary btn-sm">
                                                    <i class="fas fa-save me-1"></i> Actualizar precio
                                                </button>
                                            </div>
                                        </div>                                            
                                    </div>
                                </form>

                                {# ==== COMISIONES ==== #}
                                <form class="formulario-actualizar-moneda" data-currency-id="{{ info_tasa.moneda.id }}" method="post" autocomplete="off">
                                    {% csrf_token %}
                                    <div class="border rounded-3 p-3 mb-3">
                                        <div class="d-flex align-items-center gap-2 mb-2">
                                            <i class="fas fa-percent text-primary"></i>
                                            <strong class="mb-0">Comisiones</strong>
                                        </div>

                                        <div class="card-body">
                                            <div class="row g-3 align-items-end">
                                                <div class="col-12 col-md-6">
                                                    <label for="comision-compra-{{ info_tasa.moneda.id }}" class="form-label mb-1">Comisión de compra</label>

                                                    <div class="input-group input-group-sm">
                                                        <input
                                                            id="comision-compra-{{ info_tasa.moneda.id }}"
                                                            name="comision_compra"
                                                            type="number" inputmode="numeric"
                                                            class="form-control text-end"
                                                            step="1" min="0" placeholder="0"
                                                            value="{{ info_tasa.moneda.comision_compra|unlocalize|floatformat:0 }}"
                                                            required
                                                        >
                                                        <span class="input-group-text">PYG</span>
                                                    </div>

                                                    <div class="form-text">Enteros. Se aplica al comprar esta divisa.</div>
                                                </div>

                                                <div class="col-12 col-md-6">
                                                    <label for="comision-venta-{{ info_tasa.moneda.id }}" class="form-label mb-1">Comisión de venta</label>

                                                    <div class="input-group input-group-sm">
                                                        <input
                                                            id="comision-venta-{{ info_tasa.moneda.id }}"
                                                            name="comision_venta"
                                                            type="number" inputmode="numeric"
                                                            class="form-control text-end"
                                                            step="1" min="0" placeholder="0"
                                                            value="{{ info_tasa.moneda.comision_venta|unlocalize|floatformat:0 }}"
                                                            required
                                                        >
                                                        <span class="input-group-text">PYG</span>
                                                    </div>

                                                    <div class="form-text">Enteros. Se aplica cuando vendés esta divisa.</div>
                                                </div>

                                                <div class="col-12 d-grid d-md-flex justify-content-md-end gap-2">
                                                    <button type="submit" class="btn btn-primary btn-sm">
                                                        <i class="fas fa-save me-1"></i> Guardar cambios
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>

                                    
                                <div class="border rounded-3 p-3 mb-3">
                                    <div class="d-flex align-items-center gap-2 mb-2">
                                        <i class="fas fa-chart-line text-primary"></i>
                                        <strong class="mb-0">Tasas activas</strong>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-striped align-middle mb-0">
                                            <colgroup>
                                                <col style="width: 50%">
                                                <col style="width: 25%">
                                                <col style="width: 25%">
                                            </colgroup>
                                            <thead class="table-light">
                                                <tr>
                                                    <th class="text-muted">Categoría</th>
                                                    <th class="text-end">Compra</th>
                                                    <th class="text-end">Venta</th>
                                                </tr>
                                            </thead>
                                            <tbody class="table-group-divider">
                                                {% for tasa in info_tasa.tasas_actuales %}
                                                <tr>
                                                    <td class="text-nowrap">
                                                        <span class="badge rounded-pill bg-secondary-subtle text-secondary-emphasis">
                                                        {{ tasa.categoria_cliente.nombre }}
                                                        </span>
                                                    </td>
                                                    <td class="text-end text-success fw-semibold">
                                                        {{ tasa.tasa_compra|floatformat:0|intcomma }} PYG
                                                    </td>
                                                    <td class="text-end text-danger fw-semibold">
                                                        {{ tasa.tasa_venta|floatformat:0|intcomma }} PYG
                                                    </td>
                                                </tr>
                                                {% empty %}
                                                <tr>
                                                    <td colspan="3" class="text-center text-muted py-4">Sin tasas activas</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

   
</div>


<!-- Contenedor de Alertas de Éxito/Error -->
<div id="contenedorAlertas" style="position: fixed; top: 20px; right: 20px; z-index: 1050; max-width: 400px;"></div>

<!-- Superposición de Carga -->
<div id="superposicionCarga" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000;">
    <div class="d-flex justify-content-center align-items-center h-100">
        <div class="text-center text-white">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2">Actualizando tasas...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // No tomar el token global, se tomará del formulario en cada submit
    
    // Actualizar la hora de la última actualización
    actualizarHoraUltimaActualizacion();
    
    // Configurar actualización periódica
    setInterval(actualizarHoraUltimaActualizacion, 60000); // Actualizar cada minuto
    
    // Solo enganchar AJAX para formularios que tengan el campo precio_base
    document.querySelectorAll('.formulario-actualizar-tasa').forEach(formulario => {
        if (formulario.querySelector('input[name="precio_base"]')) {
            formulario.addEventListener('submit', function(e) {
                e.preventDefault();
                const idMoneda = this.dataset.currencyId;
                const precioBase = this.querySelector('input[name="precio_base"]').value;
                if (!precioBase || isNaN(precioBase) || parseFloat(precioBase) <= 0) {
                    mostrarAlerta('error', 'Por favor ingrese un precio base válido (> 0)');
                    return;
                }
                actualizarPrecioBase(idMoneda, precioBase, this);
            });
        }
    });

    function actualizarPrecioBase(idMoneda, precioBase, formulario) {
        const botonEnviar = formulario.querySelector('button[type="submit"]');
        const textoOriginal = botonEnviar.innerHTML;
        botonEnviar.disabled = true;
        botonEnviar.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Actualizando...';
        // Tomar el token CSRF del propio formulario
        const tokenCSRF = formulario.querySelector('[name=csrfmiddlewaretoken]').value;
        fetch('{% url "divisas:actualizar_precio_base" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': tokenCSRF,
                'X-Requested-With': 'XMLHttpRequest',   // 🔴 CLAVE
                'Accept': 'application/json'            // ayuda a negociar JSON
            },
            body: new URLSearchParams({
                'moneda_id': idMoneda,
                'precio_base': precioBase
            }),
            credentials: 'same-origin'
        })
        .then(async (res) => {
            const ct = res.headers.get('content-type') || '';
            if (!res.ok) {
            // lee el cuerpo para depurar
            const text = await res.text();
            throw new Error(`HTTP ${res.status}: ${text.slice(0,200)}`);
            }
            if (ct.includes('application/json')) {
            return res.json();
            }
            // si por algún motivo volvió HTML, lo mostramos en error legible
            const text = await res.text();
            throw new Error('Respuesta no-JSON:\n' + text.slice(0,200));
        })
        .then((data) => {
            if (data.success) {
            mostrarAlerta('success', data.message || 'Precio base actualizado correctamente');
            setTimeout(() => window.location.reload(), 600);
            } else {
            mostrarAlerta('error', (data.message || data.error) || 'Error al actualizar el precio base');
            }
        })
        .catch((err) => {
            console.error(err);
            mostrarAlerta('error', 'Error de conexión o respuesta inválida del servidor');
        })
        .finally(() => {
            botonEnviar.disabled = false;
            botonEnviar.innerHTML = textoOriginal;
        });
    }
    
    function actualizarDesdeAPI() {
        const btn = document.getElementById('btnActualizarDesdeApi');
        const textoOriginal = btn.innerHTML;
        
        // Mostrar superposición de carga
        document.getElementById('superposicionCarga').style.display = 'block';
        
        // Deshabilitar botón
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Actualizando...';
        
        fetch('{% url "divisas:api_actualizar_tasas" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': tokenCSRF
            },
            body: new URLSearchParams({
                'type': 'api'
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarAlerta('success', data.message || 'Tasas actualizadas desde API');
                // Recargar la página para mostrar los datos actualizados
                setTimeout(() => window.location.reload(), 1500);
            } else {
                mostrarAlerta('error', data.error || 'Error al actualizar desde API');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarAlerta('error', 'Error de conexión al actualizar desde API');
        })
        .finally(() => {
            // Ocultar superposición de carga
            document.getElementById('superposicionCarga').style.display = 'none';
            
            // Restaurar estado del botón
            btn.disabled = false;
            btn.innerHTML = textoOriginal;
        });
    }
    
    function mostrarAlerta(tipo, mensaje) {
        const contenedorAlertas = document.getElementById('contenedorAlertas');
        const claseAlerta = tipo === 'success' ? 'alert-success' : 'alert-danger';
        const icono = tipo === 'success' ? 'check-circle' : 'exclamation-triangle';
        
        const alerta = document.createElement('div');
        alerta.className = `alert ${claseAlerta} alert-dismissible fade show`;
        alerta.innerHTML = `
            <i class="fas fa-${icono} me-2"></i>
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        contenedorAlertas.appendChild(alerta);
        
        // Eliminar automáticamente después de 5 segundos
        setTimeout(() => {
            if (alerta.parentNode) {
                alerta.remove();
            }
        }, 5000);
    }
    
    function actualizarHoraUltimaActualizacion() {
        const ahora = new Date();
        const cadenaTiempo = ahora.toLocaleTimeString('es-ES', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        document.getElementById('horaUltimaActualizacion').textContent = cadenaTiempo;
    }
});
</script>
{% endblock %}