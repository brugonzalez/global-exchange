
{% extends 'base.html' %}
{% load humanize %}

{% block title %}Panel de Control - Global Exchange{% endblock %}

{% block content %}

<!-- Selector de Cliente (mostrado siempre para usuarios autenticados) -->
{% if user.is_authenticated %}
    <div class="container mt-3">
        <div class="client-selector">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <strong>Cliente Activo:</strong>
                    {% if user.ultimo_cliente_seleccionado %}
                        {{ user.ultimo_cliente_seleccionado.obtener_nombre_completo }}
                    {% else %}
                        <span class="text-muted">Ningún cliente seleccionado</span>
                    {% endif %}
                </div>
                <div class="col-md-4 text-end">
                    <a href="{% url 'cuentas:seleccionar_cliente' %}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-exchange-alt me-1"></i>Cambiar Cliente
                    </a>
                </div>
            </div>
        </div>
    </div>
{% endif %}

<div class="container mt-4">
    <!-- Sección de Bienvenida -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="jumbotron bg-primary text-white p-5 rounded">
                <h1 class="display-4">
                    <i class="fas fa-exchange-alt me-3"></i>
                    Bienvenido a Global Exchange
                </h1>
                <p class="lead">
                    Su casa de cambio digital de confianza. Consulte tasas en tiempo real, 
                    realice simulaciones y opere con las mejores condiciones del mercado.
                </p>
                {% if not user.is_authenticated %}
                    <div class="mt-4">
                        <a class="btn btn-light btn-lg me-3" href="{% url 'cuentas:registro' %}">
                            <i class="fas fa-user-plus me-2"></i>Registrarse
                        </a>
                        <a class="btn btn-outline-light btn-lg" href="{% url 'cuentas:iniciar_sesion' %}">
                            <i class="fas fa-sign-in-alt me-2"></i>Iniciar Sesión
                        </a>
                    </div>
                {% elif not puede_operar and not user.is_superuser %}
                    <div class="mt-4">
                        <div class="alert alert-warning d-inline-block">
                            <i class="fas fa-info-circle me-2"></i>
                            Para realizar operaciones de compra y venta, debe estar asociado a un cliente. 
                            <a href="{% url 'notificaciones:soporte' %}" class="alert-link">Contacte a soporte</a> para más información.
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Acciones Rápidas -->
    {% if user.is_authenticated and puede_operar %}
        <div class="row mb-4">
            <div class="col-12">
                <h3><i class="fas fa-bolt me-2"></i>Acciones Rápidas</h3>
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <a href="{% url 'transacciones:comprar' %}" class="btn btn-success btn-lg w-100">
                            <i class="fas fa-arrow-down me-2"></i>
                            <div>Comprar Divisas</div>
                            <small>Adquirir monedas extranjeras</small>
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="{% url 'transacciones:vender' %}" class="btn btn-warning btn-lg w-100">
                            <i class="fas fa-arrow-up me-2"></i>
                            <div>Vender Divisas</div>
                            <small>Convertir a moneda local</small>
                        </a>
                    </div>
                    <div class="col-md-3 mb-3">
                        <button onclick="openModal()" class="btn btn-info btn-lg w-100">
                            <i class="fas fa-calculator me-2"></i>
                            <div>Simular</div>
                            <small>Calcular conversiones</small>
                        </button>
                        <!--<a href="#modalSimulacion" class="btn btn-info btn-lg w-100" data-bs-toggle="modal">
                            <i class="fas fa-calculator me-2"></i>
                            <div>Simular</div>
                            <small>Calcular conversiones</small>
                        </a>-->
                    </div>
                    <div class="col-md-3 mb-3">
                        <a href="{% url 'transacciones:lista_transacciones' %}" class="btn btn-outline-primary btn-lg w-100">
                            <i class="fas fa-history me-2"></i>
                            <div>Historial</div>
                            <small>Ver transacciones</small>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Tasas de Cambio Actuales -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3><i class="fas fa-chart-line me-2"></i>Tasas de Cambio Actuales</h3>
                <div>
                    <a href="{% url 'divisas:gestionar_favoritos' %}" class="btn btn-outline-warning btn-sm">
                        <i class="fas fa-star me-1"></i>Ver Monedas Favoritas
                    </a>
                </div>
            </div>
            
            {% if datos_tasas %}
                <div class="row">
                    {% for tasa in datos_tasas %}
                        {% if not tasa.moneda.es_moneda_base %}
                            <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
                                <div class="card currency-card h-100" data-currency="{{ tasa.moneda.codigo }}">
                                    <div class="card-body text-center">
                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                            <h5 class="card-title mb-0">
                                                {% if tasa.moneda.pais %}
                                                    <img src="{{ tasa.moneda.pais.flag }}"
                                                        alt="{{ tasa.moneda.pais.name }}"
                                                        width="20" height="14"
                                                        class="align-middle me-1">
                                                {% else %}
                                                    <div class="d-inline-block align-middle me-1" style="width: 20px; height: 14px; background-color: #f8f9fa; border: 1px solid #dee2e6;"></div>
                                                {% endif %}
                                                {{ tasa.moneda.simbolo }} {{ tasa.moneda.codigo }}
                                            </h5>
                                        </div>

                                        <h6 class="text-muted">{{ tasa.moneda.nombre }}</h6>

                                        <div class="row mt-3">
                                            <div class="col-6">
                                                <div class="border-end">
                                                    <strong class="text-success">Compra</strong>
                                                    <div class="h5 tasa-compra">{{ tasa.tasa_compra|floatformat:0 }} PYG </div>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <strong class="text-danger">Venta</strong>
                                                <div class="h5 tasa-venta">{{ tasa.tasa_venta|floatformat:0 }} PYG</div>
                                            </div>
                                        </div>

                                        <div class="mt-3">
                                            <small class="text-muted ultima-actualizacion">
                                                Actualizado: {{ tasa.ultima_actualizacion|date:"H:i" }}
                                            </small>
                                        </div>

                                        <div class="mt-3">
                                            <div class="btn-group w-100" role="group">
                                                <a href="{% url 'divisas:historial_tasa' tasa.moneda.codigo %}"
                                                   class="btn btn-outline-primary btn-sm">
                                                    <i class="fas fa-chart-area me-1"></i>Historial
                                                </a>
                                                {% if user.is_authenticated and puede_operar %}
                                                    {% if tasa.moneda.disponible_para_compra %}
                                                        <button class="btn btn-outline-success btn-sm"
                                                                onclick="simulacionRapida('{{ tasa.moneda.codigo }}', 'COMPRA')">
                                                            <i class="fas fa-arrow-down me-1"></i>Comprar
                                                        </button>
                                                    {% endif %}
                                                    {% if tasa.moneda.disponible_para_venta %}
                                                        <button class="btn btn-outline-warning btn-sm"
                                                                onclick="simulacionRapida('{{ tasa.moneda.codigo }}', 'VENTA')">
                                                            <i class="fas fa-arrow-up me-1"></i>Vender
                                                        </button>
                                                    {% endif %}
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    No hay tasas de cambio disponibles en este momento.
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Resumen del Mercado -->
    <div class="row mb-4">
        <div class="col-12">
            <h3><i class="fas fa-globe me-2"></i>Resumen del Mercado</h3>
            <div class="row">
                <div class="col-md-4 mb-3">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <i class="fas fa-coins fa-2x text-primary mb-2"></i>
                            <h5>{{ datos_tasas|length }}</h5>
                            <p class="mb-0">Monedas Disponibles</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <i class="fas fa-clock fa-2x text-info mb-2"></i>
                            <h5>24/7</h5>
                            <p class="mb-0">Disponibilidad</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <i class="fas fa-shield-alt fa-2x text-success mb-2"></i>
                            <h5>100%</h5>
                            <p class="mb-0">Seguro</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Características -->
    <div class="row mb-4">
        <div class="col-12">
            <h3><i class="fas fa-star me-2"></i>Características</h3>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-sync-alt text-primary me-2"></i>
                                Tasas en Tiempo Real
                            </h5>
                            <p class="card-text">
                                Acceda a las tasas de cambio más actualizadas del mercado, 
                                con actualizaciones manuales realizadas por nuestros administradores.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-calculator text-success me-2"></i>
                                Simulador de Conversiones
                            </h5>
                            <p class="card-text">
                                Calcule el resultado de sus operaciones antes de ejecutarlas, 
                                sin compromiso y de forma gratuita.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-mobile-alt text-info me-2"></i>
                                Transacciones Digitales
                            </h5>
                            <p class="card-text">
                                Realice compras y ventas de divisas completamente en línea, 
                                con transferencias directas a sus cuentas.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title">
                                <i class="fas fa-file-invoice text-warning me-2"></i>
                                Facturación Electrónica
                            </h5>
                            <p class="card-text">
                                Reciba facturas electrónicas por todas sus transacciones, 
                                con validez fiscal completa.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Simulación -->
<div class="modal fade" id="modalSimulacion" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-calculator me-2"></i>
                    Simular Conversión
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Nota: Los resultados de la simulación son aproximados y no constituyen una oferta vinculante.
                <form id="formularioSimulacion">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="tipo_transaccion" class="form-label">Tipo de Operación</label>
                            <select class="form-select" id="tipo_transaccion" name="tipo_transaccion">
                                <option value="COMPRA">Comprar</option>
                                <option value="VENTA">Vender</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="tasa_aplicada" class="form-label">Tasa de cambio aplicada</label>
                            <div id="tasa_aplicada" class="form-control-plaintext fw-semibold">
                                <!-- Si la operación es compra: mostrar la tasa de venta, si la operación es venta: mostrar la tasa de compra -->
                                <!-- La tasa se actualizará dinámicamente por JS -->
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="moneda_origen" class="form-label">Moneda Origen</label>
                            <select class="form-select" id="moneda_origen" name="moneda_origen">
                                {% for tasa in datos_tasas %}
                                    <option value="{{ tasa.moneda.id }}" {% if tasa.moneda.es_moneda_base %}selected{% endif %}>{{ tasa.moneda.codigo }} - {{ tasa.moneda.nombre }}</option>
                                {% endfor %}
                            </select>
                            {% for tasa in datos_tasas %}
                                {% if tasa.moneda.es_moneda_base %}
                                    <input type="hidden" name="pais" value="{{ tasa.moneda.id }}" id="moneda_origen_input">
                                {% endif %}
                            {% endfor %}
                            <div class="mt-2">
                                <label for="cantidad_entregar" class="form-label">Cantidad a entregar</label>
                                <input type="number" class="form-control" id="cantidad_entregar" name="cantidad_entregar"
                                    step="1" min="0" placeholder="0" autocomplete="off">
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="moneda_destino" class="form-label">Moneda Destino</label>
                            <select class="form-select" id="moneda_destino" name="moneda_destino">
                                {% for tasa in datos_tasas %}
                                    {% if not tasa.moneda.es_moneda_base and tasa.moneda.disponible_para_compra %}
                                        <option value="{{ tasa.moneda.id }}"
                                            {% if forloop.counter == 2 %}
                                                selected
                                            {% elif forloop.first and datos_tasas|length == 1 %}
                                                selected
                                            {% endif %}
                                        >
                                            {{ tasa.moneda.codigo }} - {{ tasa.moneda.nombre }}
                                        </option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                            <div class="mt-2">
                                <label for="cantidad_recibir" class="form-label">Cantidad a recibir</label>
                                <input type="number" class="form-control" id="cantidad_recibir" name="cantidad_recibir"
                                    step="1" min="0" placeholder="0" autocomplete="off">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-calculator me-2"></i>Calcular
                            </button>
                        </div>
                    </div>
                </form>
                
                <div id="resultadoSimulacion" class="mt-4" style="display: none;">
                    <div class="alert alert-success">
                        <h5><i class="fas fa-check-circle me-2"></i>Resultado de la Simulación</h5>
                        <div id="contenidoResultado"></div>
                        {% if user.is_authenticated and puede_operar %}
                            <div class="mt-3">
                                <button class="btn btn-success" onclick="procederConTransaccion()">
                                    <i class="fas fa-arrow-right me-2"></i>Proceder con la Transacción
                                </button>
                            </div>
                        {% endif %}
                    </div>
                </div>
                
                <div id="errorSimulacion" class="mt-4" style="display: none;">
                    <div class="alert alert-danger">
                        <h5><i class="fas fa-exclamation-circle me-2"></i>Error</h5>
                        <div id="contenidoError"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Manejo del formulario de simulación - usando la API fetch para un manejo adecuado de FormData
    document.addEventListener('DOMContentLoaded', function() {
        const formularioSimulacion = document.getElementById('formularioSimulacion');
        const datosTasas = JSON.parse('{{ datos_tasas_json|escapejs }}');
        const selectTipo = document.getElementById("tipo_transaccion");
        const selectMonedaOrigen = document.getElementById("moneda_origen");
        const selectMonedaDestino = document.getElementById("moneda_destino");
        const tasaAplicadaDiv = document.getElementById("tasa_aplicada");

        function reconstruirSelects(tipo, codigoMoneda) {
            if (tipo === 'COMPRA') {
                selectMonedaDestino.disabled = false;
                selectMonedaOrigen.disabled = true;
                selectMonedaDestino.innerHTML = "";
                selectMonedaOrigen.innerHTML = "";
                // Moneda base en origen
                const monedaBase = datosTasas.find(tasa => tasa.moneda.moneda_base);
                if (monedaBase) {
                    const opcionBase = document.createElement("option");
                    opcionBase.value = monedaBase.moneda.id;
                    opcionBase.text = `${monedaBase.moneda.codigo} - ${monedaBase.moneda.nombre}`;
                    opcionBase.selected = true;
                    selectMonedaOrigen.appendChild(opcionBase);
                }
                // Monedas extranjeras en destino
                datosTasas.forEach(tasa => {
                    if (!tasa.moneda.moneda_base && tasa.moneda.disponible_compra) {
                        const opcion = document.createElement("option");
                        opcion.value = tasa.moneda.id;
                        opcion.text = `${tasa.moneda.codigo} - ${tasa.moneda.nombre}`;
                        if (codigoMoneda && tasa.moneda.codigo === codigoMoneda) {
                            opcion.selected = true;
                        }
                        selectMonedaDestino.appendChild(opcion);
                    }
                });
            } else {
                selectMonedaOrigen.disabled = false;
                selectMonedaDestino.disabled = true;
                selectMonedaDestino.innerHTML = "";
                selectMonedaOrigen.innerHTML = "";
                // Moneda base en destino
                const monedaBase = datosTasas.find(tasa => tasa.moneda.moneda_base);
                if (monedaBase) {
                    const opcionBase = document.createElement("option");
                    opcionBase.value = monedaBase.moneda.id;
                    opcionBase.text = `${monedaBase.moneda.codigo} - ${monedaBase.moneda.nombre}`;
                    opcionBase.selected = true;
                    selectMonedaDestino.appendChild(opcionBase);
                }
                // Monedas extranjeras en origen
                datosTasas.forEach(tasa => {
                    if (!tasa.moneda.moneda_base && tasa.moneda.disponible_venta) {
                        const opcion = document.createElement("option");
                        opcion.value = tasa.moneda.id;
                        opcion.text = `${tasa.moneda.codigo} - ${tasa.moneda.nombre}`;
                        if (codigoMoneda && tasa.moneda.codigo === codigoMoneda) {
                            opcion.selected = true;
                        }
                        selectMonedaOrigen.appendChild(opcion);
                    }
                });
            }
        }

        function getTasaAplicada() {
            const tipo = selectTipo.value;
            let tasa = null;
            if (tipo === "COMPRA") {
                // Usar tasa_venta de la moneda destino
                const idDestino = selectMonedaDestino.value;
                const objDestino = datosTasas.find(t => String(t.moneda.id) === String(idDestino));
                tasa = objDestino ? objDestino.tasa_venta : null;
            } else {
                // Usar tasa_compra de la moneda origen
                const idOrigen = selectMonedaOrigen.value;
                const objOrigen = datosTasas.find(t => String(t.moneda.id) === String(idOrigen));
                tasa = objOrigen ? objOrigen.tasa_compra : null;
            }
            return tasa;
        }

        function updateTasaAplicada() {
            const tasa = getTasaAplicada();
            if (tasaAplicadaDiv) {
                let textoMoneda = '';
                const tipo = selectTipo.value;
                if (tipo === 'COMPRA') {
                    // Moneda destino es la extranjera
                    textoMoneda = selectMonedaDestino.options[selectMonedaDestino.selectedIndex]?.text || '';
                } else {
                    // Moneda origen es la extranjera
                    textoMoneda = selectMonedaOrigen.options[selectMonedaOrigen.selectedIndex]?.text || '';
                }
                tasaAplicadaDiv.textContent = tasa !== null && tasa !== undefined ? Number(tasa).toLocaleString('es-ES', {minimumFractionDigits: 0, maximumFractionDigits: 8}) + ' PYG = 1 ' + textoMoneda : '—';
            }
        }

        selectTipo.addEventListener("change", function() {
            reconstruirSelects(selectTipo.value);
            updateTasaAplicada();
        });
        selectMonedaOrigen.addEventListener("change", updateTasaAplicada);
        selectMonedaDestino.addEventListener("change", updateTasaAplicada);

        // Inicializar al cargar
        reconstruirSelects(selectTipo.value);
        updateTasaAplicada();

        if (formularioSimulacion) {
        formularioSimulacion.addEventListener('submit', async function (e) {
            e.preventDefault();

            const tipo = selectTipo.value; // "COMPRA" | "VENTA"
            const montoEntregar = document.getElementById('cantidad_entregar')?.value || '';
            const montoRecibir  = document.getElementById('cantidad_recibir')?.value || '';
            const amount = montoEntregar || montoRecibir || '0';

            const datos = new FormData();
            // Compat + campos que suelen necesitar los endpoints
            datos.set('tipo_transaccion', tipo);
            datos.set('transaction_type', tipo === 'COMPRA' ? 'BUY' : 'SELL');
            datos.set('moneda_origen',  selectMonedaOrigen.value);
            datos.set('moneda_destino', selectMonedaDestino.value);
            if (tipo === 'COMPRA') {
            // Cliente compra divisa: ORIGEN = PYG (base), DESTINO = divisa
            datos.set('currency_to',   selectMonedaDestino.value);
            } else {
            // Cliente vende divisa: ORIGEN = divisa, DESTINO = PYG (base)
            datos.set('currency_from', selectMonedaOrigen.value);
            }
            datos.set('amount', amount); // nombre “genérico”
            datos.set('monto',  amount); // compat con tu render de resultado

            const tokenCSRF =
            document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
            document.querySelector('meta[name=csrf-token]')?.getAttribute('content') ||
            (document.cookie.split('; ').find(c=>c.startsWith('csrftoken='))||'').split('=')[1];

            try {
            const resp = await fetch('{% url "divisas:api_simular" %}', {
                method: 'POST',
                headers: { 'X-CSRFToken': tokenCSRF },
                body: datos
            });
            const respuesta = await resp.json();

            const divError = document.getElementById('errorSimulacion');
            const divResultado = document.getElementById('resultadoSimulacion');
            const contenidoResultado = document.getElementById('contenidoResultado');
            const contenidoError = document.getElementById('contenidoError');

            if (respuesta.success) {
                if (divError) divError.style.display = 'none';

                const montoConv = (typeof respuesta.monto_convertido === 'number')
                ? respuesta.monto_convertido.toFixed(4)
                : respuesta.monto_convertido ?? '—';
                const tasaTxt = (typeof respuesta.tasa === 'number')
                ? respuesta.tasa.toFixed(8)
                : respuesta.tasa ?? '—';

                const htmlResultado = `
                <div class="row">
                    <div class="col-md-6">
                    <strong>Cantidad a entregar:</strong> ${(() => {
                        const origen = datosTasas.find(t => String(t.moneda.id) === String(selectMonedaOrigen.value));
                        return isFinite(montoEntregar) && origen ? Number(montoEntregar).toLocaleString('es-ES', {minimumFractionDigits: origen.moneda.lugares_decimales, maximumFractionDigits: origen.moneda.lugares_decimales}) + ' ' + origen.moneda.codigo : '—';
                    })()}<br>
                    <strong>Cantidad a recibir:</strong> ${(() => {
                        const destino = datosTasas.find(t => String(t.moneda.id) === String(selectMonedaDestino.value));
                        return isFinite(montoRecibir) && destino ? Number(montoRecibir).toLocaleString('es-ES', {minimumFractionDigits: destino.moneda.lugares_decimales, maximumFractionDigits: destino.moneda.lugares_decimales}) + ' ' + destino.moneda.codigo : '—';
                    })()}
                    </div>
                    <div class="col-md-6">
                    <strong>Tasa Aplicada:</strong> ${(() => {
                        let textoMoneda = '';
                        const tipo = selectTipo.value;
                        let tasa = null;
                        if (tipo === 'COMPRA') {
                            const destino = datosTasas.find(t => String(t.moneda.id) === String(selectMonedaDestino.value));
                            textoMoneda = destino ? destino.moneda.codigo : '';
                            tasa = destino ? destino.tasa_venta : null;
                        } else {
                            const origen = datosTasas.find(t => String(t.moneda.id) === String(selectMonedaOrigen.value));
                            textoMoneda = origen ? origen.moneda.codigo : '';
                            tasa = origen ? origen.tasa_compra : null;
                        }
                        return isFinite(tasa)
                            ? Number(tasa).toLocaleString('es-ES', {minimumFractionDigits: 0, maximumFractionDigits: 8}) + ' PYG = 1 ' + textoMoneda
                            : tasaTxt;
                    })()}
                    </div>
                </div>
                `;
                if (contenidoResultado) contenidoResultado.innerHTML = htmlResultado;
                if (divResultado) divResultado.style.display = 'block';
            } else {
                if (divResultado) divResultado.style.display = 'none';
                if (contenidoError) contenidoError.textContent = respuesta.error || 'Error desconocido';
                if (divError) divError.style.display = 'block';
            }
            } catch {
            const divError = document.getElementById('errorSimulacion');
            const divResultado = document.getElementById('resultadoSimulacion');
            const contenidoError = document.getElementById('contenidoError');
            if (divResultado) divResultado.style.display = 'none';
            if (contenidoError) contenidoError.textContent = 'Error de conexión. Intente nuevamente.';
            if (divError) divError.style.display = 'block';
            }
        });
        }
    });
    
    // Función de simulación rápida
    function simulacionRapida(codigoMoneda, tipo) {
        // Establecer valores por defecto en el modal de simulación
        const elTipoTransaccion = document.getElementById('tipo_transaccion');
        const opcionesMonedaDestino = document.querySelectorAll('#moneda_destino option');
        const opcionesMonedaOrigen = document.querySelectorAll('#moneda_origen option');
        const selectMonedaOrigen = document.getElementById("moneda_origen");
        const selectMonedaDestino = document.getElementById("moneda_destino");
        const datosTasas = JSON.parse('{{ datos_tasas_json|escapejs }}');
        const resultadoSimulacion = document.getElementById('resultadoSimulacion');
        const errorSimulacion = document.getElementById('errorSimulacion');
        const inputMonto = document.getElementById('monto');
        
        if (elTipoTransaccion) elTipoTransaccion.value = tipo;
        
        if (tipo === 'COMPRA') {

            console.log("Selecciono compra");
            // Habilitar moneda destino y deshabilitar moneda origen
            selectMonedaDestino.disabled = false;
            selectMonedaOrigen.disabled = true;

            // Limpiar ambos selects
            selectMonedaDestino.innerHTML = "";
            selectMonedaOrigen.innerHTML = "";

            // Agregar la moneda base al select origen
            const monedaBase = datosTasas.find(tasa => tasa.moneda.moneda_base);
            if (monedaBase) {
                const opcionBase = document.createElement("option");
                opcionBase.value = monedaBase.moneda.id;
                opcionBase.text = `${monedaBase.moneda.codigo} - ${monedaBase.moneda.nombre}`;
                opcionBase.selected = true;
                selectMonedaOrigen.appendChild(opcionBase);
            }

            // Agregar las monedas NO base al select destino
            datosTasas.forEach(tasa => {
                if (!tasa.moneda.moneda_base && tasa.moneda.disponible_compra) {
                    const opcion = document.createElement("option");
                    opcion.value = tasa.moneda.id;
                    opcion.text = `${tasa.moneda.codigo} - ${tasa.moneda.nombre}`;
                    if(tasa.moneda.codigo === codigoMoneda) {
                        opcion.selected = true;
                    }
                    selectMonedaDestino.appendChild(opcion);
                }
            });

        } else {
            console.log("Selecciono venta");
            // Habilitar moneda origen y deshabilitar moneda destino
            selectMonedaOrigen.disabled = false;
            selectMonedaDestino.disabled = true;
            // Primero vaciamos todas las opciones existentes
            selectMonedaDestino.innerHTML = "";
            selectMonedaOrigen.innerHTML = "";

            const nuevaOpcion = document.createElement("option");
            const monedaBase = datosTasas.find(tasa => tasa.moneda.moneda_base);
            nuevaOpcion.value = monedaBase.moneda.id;
            nuevaOpcion.text = `${monedaBase.moneda.codigo} - ${monedaBase.moneda.nombre}`;
             // Agregamos la nueva opción al select
            selectMonedaDestino.appendChild(nuevaOpcion);

            // Agregar las monedas NO base al select origen
            datosTasas.forEach(tasa => {
                if (!tasa.moneda.moneda_base && tasa.moneda.disponible_venta) {
                    const opcion = document.createElement("option");
                    opcion.value = tasa.moneda.id;
                    opcion.text = `${tasa.moneda.codigo} - ${tasa.moneda.nombre}`;
                    if(tasa.moneda.codigo === codigoMoneda) {
                        opcion.selected = true;
                    }
                    selectMonedaOrigen.appendChild(opcion);
                }
            });
        }

        // Limpiar resultados previos
        if (resultadoSimulacion) resultadoSimulacion.style.display = 'none';
        if (errorSimulacion) errorSimulacion.style.display = 'none';
        if (inputMonto) inputMonto.value = '';
        
        // Mostrar modal (si la funcionalidad de modal de Bootstrap existe)
        const elModal = document.getElementById('modalSimulacion');
        if (elModal && window.bootstrap) {
            new bootstrap.Modal(elModal).show();
        }
    }
    
    // Función para proceder con la transacción
    function procederConTransaccion() {
        const elTipoTransaccion = document.getElementById('tipo_transaccion');
        const monedaOrigen = document.getElementById('moneda_origen');
        const monedaDestino = document.getElementById('moneda_destino');
        const cantidadEntregar = document.getElementById('cantidad_entregar');
        const cantidadRecibir = document.getElementById('cantidad_recibir');
        if (elTipoTransaccion) {
            const tipo = elTipoTransaccion.value;
            // Obtiene los valores actuales
            const moneda_origen = monedaOrigen ? monedaOrigen.value : '';
            const moneda_destino = monedaDestino ? monedaDestino.value : '';
            const monto_entregar = cantidadEntregar ? cantidadEntregar.value : '';
            const monto_recibir = cantidadRecibir ? cantidadRecibir.value : '';
            // Construye los parámetros para la URL
            const params = new URLSearchParams({
                tipo_transaccion: tipo,
                moneda_origen,
                moneda_destino,
                monto_entregar,
                monto_recibir
            }).toString();
            if (tipo === 'COMPRA') {
                window.location.href = '{% url "transacciones:comprar" %}?' + params;
            } else {
                window.location.href = '{% url "transacciones:vender" %}?' + params;
            }
        }
    }

    function openModal() {
        const elModal = document.getElementById('modalSimulacion');
        const resultadoSimulacion = document.getElementById('resultadoSimulacion');
        const errorSimulacion = document.getElementById('errorSimulacion');
        const inputMonto = document.getElementById('monto');
        // Limpiar resultados previos
        if (resultadoSimulacion) resultadoSimulacion.style.display = 'none';
        if (errorSimulacion) errorSimulacion.style.display = 'none';
        if (inputMonto) inputMonto.value = '';

        if (elModal && window.bootstrap) {
            new bootstrap.Modal(elModal).show();
        }
    }
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const datosTasas = JSON.parse('{{ datos_tasas_json|escapejs }}');

  const tipoSel    = document.getElementById('tipo_transaccion');
  const selOrigen  = document.getElementById('moneda_origen');
  const selDestino = document.getElementById('moneda_destino');
  const inpEntregar= document.getElementById('cantidad_entregar');
  const inpRecibir = document.getElementById('cantidad_recibir');
  const tasaOut    = document.getElementById('tasa_aplicada');

  let lock = false; // evita loops de eventos

  function findItemByMonedaId(id) {
    return datosTasas.find(t => String(t.moneda.id) === String(id));
  }

  function getDecimalsByMonedaId(id) {
    const it = findItemByMonedaId(id);
    const d  = parseInt(it?.moneda?.lugares_decimales ?? 2, 10);
    return Number.isFinite(d) ? Math.max(0, Math.min(8, d)) : 2;
  }

  function stepFromDecimals(d) { return d <= 0 ? '1' : `1e-${d}`; }

  function applyStepsPlaceholders() {
    const dEnt = getDecimalsByMonedaId(selOrigen.value);
    const dRec = getDecimalsByMonedaId(selDestino.value);

    if (inpEntregar) {
      inpEntregar.step = stepFromDecimals(dEnt);
      inpEntregar.placeholder = dEnt === 0 ? '0' : ('0.' + '0'.repeat(dEnt));
      inpEntregar.inputMode = 'decimal';
      inpEntregar.dataset.decimals = dEnt;
    }
    if (inpRecibir) {
      inpRecibir.step = stepFromDecimals(dRec);
      inpRecibir.placeholder = dRec === 0 ? '0' : ('0.' + '0'.repeat(dRec));
      inpRecibir.inputMode = 'decimal';
      inpRecibir.dataset.decimals = dRec;
    }
  }

  // Tasa aplicada: COMPRA -> tasa_venta (de la moneda destino), VENTA -> tasa_compra (de la moneda origen)
  function getTasa() {
    if (tipoSel.value === 'COMPRA') {
      const item = findItemByMonedaId(selDestino.value);
      return item ? Number(item.tasa_venta) : NaN;
    } else {
      const item = findItemByMonedaId(selOrigen.value);
      return item ? Number(item.tasa_compra) : NaN;
    }
  }

  function pintarTasa() {
    const t = getTasa();
    if (!tasaOut) return;
    const labelMoneda = (tipoSel.value === 'COMPRA'
      ? selDestino.options[selDestino.selectedIndex]?.text
      : selOrigen.options[selOrigen.selectedIndex]?.text) || '';
    tasaOut.textContent = (isFinite(t) ? t.toLocaleString('es-ES', { minimumFractionDigits: 0, maximumFractionDigits: 8 }) + ' PYG = 1 ' + labelMoneda : '—');
  }

  function calcDesdeEntregar() {
    if (lock) return; lock = true;
    const t = getTasa();
    const x = Number(inpEntregar.value);
    const dRec = getDecimalsByMonedaId(selDestino.value);
    if (!isFinite(x) || x <= 0 || !isFinite(t) || t <= 0) {
      inpRecibir.value = '';
      lock = false; return;
    }
    if (tipoSel.value === 'COMPRA') {
      // entrega Gs, recibe divisa
      inpRecibir.value = (x / t).toFixed(dRec);
    } else {
      // entrega divisa, recibe Gs
      inpRecibir.value = (x * t).toFixed(dRec);
    }
    lock = false;
  }

  function calcDesdeRecibir() {
    if (lock) return; lock = true;
    const t = getTasa();
    const y = Number(inpRecibir.value);
    const dEnt = getDecimalsByMonedaId(selOrigen.value);
    if (!isFinite(y) || y <= 0 || !isFinite(t) || t <= 0) {
      inpEntregar.value = '';
      lock = false; return;
    }
    if (tipoSel.value === 'COMPRA') {
      // entregar Gs = recibir * tasa_venta
      inpEntregar.value = (y * t).toFixed(dEnt);
    } else {
      // entregar divisa = recibir Gs / tasa_compra
      inpEntregar.value = (y / t).toFixed(dEnt);
    }
    lock = false;
  }

  function recalcAuto() {
    pintarTasa();
    applyStepsPlaceholders();
    // recalcula en función de cuál tiene valor
    if (inpEntregar.value) calcDesdeEntregar();
    else if (inpRecibir.value) calcDesdeRecibir();
  }

  // === Listeners para calcular en cada caracter ===
  inpEntregar && inpEntregar.addEventListener('input', calcDesdeEntregar);
  inpRecibir  && inpRecibir.addEventListener('input',  calcDesdeRecibir);

  // Cuando cambia el tipo o las monedas, actualizamos tasa, steps y recalculamos
  tipoSel   && tipoSel.addEventListener('change',  recalcAuto);
  selOrigen && selOrigen.addEventListener('change', recalcAuto);
  selDestino&& selDestino.addEventListener('change',recalcAuto);

  // Init
  applyStepsPlaceholders();
  pintarTasa();
});
document.addEventListener('DOMContentLoaded', function () {
  const modalEl   = document.getElementById('modalSimulacion');
  const form      = document.getElementById('formularioSimulacion');
  const tipoSel   = document.getElementById('tipo_transaccion');
  const selOrigen = document.getElementById('moneda_origen');
  const selDestino= document.getElementById('moneda_destino');
  const ent       = document.getElementById('cantidad_entregar');
  const rec       = document.getElementById('cantidad_recibir');
  const tasaOut   = document.getElementById('tasa_aplicada');

  // Usa tu propia función reconstruirSelects si ya la tienes en ese scope:
  const datosTasas = JSON.parse('{{ datos_tasas_json|escapejs }}');
  function reconstruirSelects(tipo) {
    // --- misma implementación que ya tienes arriba ---
    // (pega aquí o llama a la que ya definiste en el script anterior)
  }

  function resetSimulador() {
    // 1) Resetea el form (limpia inputs y vuelve selects a su markup inicial)
    if (form) form.reset();

    // 2) Fuerza estado inicial deseado:
    if (tipoSel) tipoSel.value = 'COMPRA';    // o lo que quieras por defecto

    // 3) Reconstruye selects base/extranjeras según “COMPRA”
    reconstruirSelects(tipoSel.value);

    // 4) Limpia campos, resultados y tasa
    if (ent) ent.value = '';
    if (rec) rec.value = '';

    // 5) Oculta tarjetas de resultado/error
    const resBox = document.getElementById('resultadoSimulacion');
    const errBox = document.getElementById('errorSimulacion');
    if (resBox) resBox.style.display = 'none';
    if (errBox) errBox.style.display = 'none';
  }

  if (modalEl) {
    // Al ABRIR: limpia todo y enfoca el primer campo
    modalEl.addEventListener('shown.bs.modal', function () {
      resetSimulador();
      // enfocar cantidad a entregar
      setTimeout(() => ent && ent.focus(), 0);
    });

    // Al CERRAR: por si el navegador intenta recordar, deja todo vacío
    modalEl.addEventListener('hidden.bs.modal', function () {
      resetSimulador();
    });
  }
});
</script>

{% endblock %}
