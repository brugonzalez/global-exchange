{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Asociar Usuario - {{ cliente.obtener_nombre_completo }} - Global Exchange{% endblock %}

{% block extra_css %}
<style>
    .client-info-card {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        border-radius: 10px;
        margin-bottom: 20px;
    }
    
    .form-section {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        border-left: 4px solid #28a745;
    }
    
    .user-preview {
        border: 2px dashed #dee2e6;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        margin-top: 20px;
        transition: all 0.3s ease;
    }
    
    .user-preview.selected {
        border-color: #28a745;
        background-color: #f8fff9;
    }
    
    .permissions-help {
        background-color: #e3f2fd;
        border-radius: 5px;
        padding: 15px;
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Encabezado de Información del Cliente -->
            <div class="card client-info-card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h4 class="mb-1">
                                <i class="fas fa-user-plus me-2"></i>
                                Asociar Usuario a Cliente
                            </h4>
                            <p class="mb-0">Cliente: <strong>{{ cliente.obtener_nombre_completo }}</strong></p>
                            <small>{{ cliente.get_tipo_cliente_display }} - {{ cliente.numero_identificacion }}</small>
                        </div>
                        <div class="col-md-4 text-end">
                            <a href="{% url 'clientes:gestionar_usuarios_cliente' cliente.id %}" class="btn btn-light">
                                <i class="fas fa-arrow-left me-1"></i>Volver
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Formulario -->
            <div class="form-section">
                <h5 class="mb-4">
                    <i class="fas fa-user-cog me-2"></i>
                    Información de la Asociación
                </h5>

                <form method="post" id="formularioAsignarUsuario">
                    {% csrf_token %}
                    
                    <!-- Selección de Usuario -->
                    <div class="mb-4">
                        {{ form.usuario|as_crispy_field }}
                        
                        <div class="user-preview" id="vistaPreviaUsuario" style="display: none;">
                            <i class="fas fa-user fa-2x mb-2 text-muted"></i>
                            <h6 id="nombreUsuarioSeleccionado">Usuario seleccionado</h6>
                        </div>
                    </div>


                    <!-- Estado Activo -->
                    <div class="mb-4">
                        <div class="form-check">
                            {{ form.esta_activo }}
                            <label class="form-check-label" for="{{ form.esta_activo.id_for_label }}">
                                <strong>Usuario activo</strong>
                                <br>
                                <small class="text-muted">
                                    Si está marcado, el usuario podrá operar inmediatamente. 
                                    Si no está marcado, la asociación estará inactiva.
                                </small>
                            </label>
                        </div>
                    </div>

                    <!-- Botones de Acción -->
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'clientes:gestionar_usuarios_cliente' cliente.id %}" class="btn btn-secondary">
                            <i class="fas fa-times me-1"></i>Cancelar
                        </a>
                        
                        <button type="submit" class="btn btn-success" id="botonEnviar">
                            <i class="fas fa-user-plus me-1"></i>Asociar Usuario
                        </button>
                    </div>
                </form>
            </div>

            <!-- Información de Asociaciones Actuales -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Información Importante
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-primary">
                                <i class="fas fa-check-circle me-1"></i>
                                Al asociar este usuario:
                            </h6>
                            <ul class="small">
                                <li>Podrá operar en nombre del cliente.</li>
                                <li>Tendrá acceso según el rol asignado.</li>
                                <li>Aparecerá en el selector de clientes del usuario.</li>
                                <li>Se registrará en los registros de auditoría.</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-warning">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                Consideraciones:
                            </h6>
                            <ul class="small">
                                <li>Verifique la identidad del usuario.</li>
                                <li>Asigne el rol mínimo necesario.</li>
                                <li>Revise los permisos periódicamente.</li>
                                <li>Mantenga un registro de las autorizaciones.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectorUsuario = document.getElementById('id_usuario');
    const vistaPreviaUsuario = document.getElementById('vistaPreviaUsuario');
    const nombreUsuarioSeleccionado = document.getElementById('nombreUsuarioSeleccionado');
    //const emailUsuarioSeleccionado = document.getElementById('emailUsuarioSeleccionado');
    //const selectorRol = document.getElementById('id_rol');
    const botonEnviar = document.getElementById('botonEnviar');
    const formulario = document.getElementById('formularioAsignarUsuario');

    // Verificar el token CSRF al cargar la página
    function verificarTokenCSRF() {
        const tokenCSRF = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!tokenCSRF || !tokenCSRF.value) {
            console.warn('Falta el token CSRF al cargar la página');
            // Intentar refrescar el token
            fetch('{% url "clientes:anadir_usuario_cliente" cliente.id %}', {
                method: 'GET',
                credentials: 'same-origin'
            }).then(response => {
                if (!response.ok) {
                    console.error('No se pudo refrescar el token CSRF');
                }
            }).catch(error => {
                console.error('Error al refrescar el token CSRF:', error);
            });
        }
    }

    // Verificación inicial de CSRF
    verificarTokenCSRF();

    // Actualizar la vista previa del usuario cuando cambia la selección
    selectorUsuario.addEventListener('change', function() {
        const opcionSeleccionada = this.options[this.selectedIndex];
        
        if (this.value) {
            const nombreUsuario = opcionSeleccionada.text.split(' ( ')[0]; // Extraer la parte del nombre
            //const emailUsuario = opcionSeleccionada.text.split(' - ')[1] || 'Email no disponible';
            
            nombreUsuarioSeleccionado.textContent = nombreUsuario;
            //emailUsuarioSeleccionado.textContent = emailUsuario;
            vistaPreviaUsuario.style.display = 'block';
            vistaPreviaUsuario.classList.add('selected');
        } else {
            vistaPreviaUsuario.style.display = 'none';
            vistaPreviaUsuario.classList.remove('selected');
        }
        
        actualizarBotonEnviar();
    });

    // Actualizar la ayuda basada en el rol
    //selectorRol.addEventListener('change', actualizarBotonEnviar);

    function actualizarBotonEnviar() {
        const hayUsuario = selectorUsuario.value !== '';
        //const hayRol = selectorRol.value !== '';
        
        botonEnviar.disabled = !hayUsuario;
        
        if (hayUsuario) {
            botonEnviar.innerHTML = '<i class="fas fa-user-plus me-1"></i>Asociar Usuario';
            botonEnviar.classList.remove('btn-secondary');
            botonEnviar.classList.add('btn-success');
        } else {
            botonEnviar.innerHTML = '<i class="fas fa-user-plus me-1"></i>Seleccione usuario y rol';
            botonEnviar.classList.remove('btn-success');
            botonEnviar.classList.add('btn-secondary');
        }
    }

    // Validación del formulario
    formulario.addEventListener('submit', function(e) {
        const usuario = selectorUsuario.value;
        //const rol = selectorRol.value;
        
        if (!usuario) {
            e.preventDefault();
            alert('Por favor seleccione un usuario y un rol antes de continuar.');
            return;
        }

        // Validación del token CSRF
        const tokenCSRF = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!tokenCSRF || !tokenCSRF.value) {
            e.preventDefault();
            alert('Error de seguridad: Falta el token CSRF. La página se recargará para resolver el problema.');
            window.location.reload();
            return;
        }

        // Validar permisos JSON si se proporcionan
        const textareaPermisos = document.getElementById('id_permisos');
        const permisos = textareaPermisos.value.trim();
        
        if (permisos) {
            try {
                JSON.parse(permisos);
            } catch (error) {
                e.preventDefault();
                alert('Los permisos deben estar en formato JSON válido.');
                textareaPermisos.focus();
                return;
            }
        }

        // Diálogo de confirmación
        const nombreUsuario = selectorUsuario.options[selectorUsuario.selectedIndex].text.split(' - ')[0];
        //const nombreRol = selectorRol.options[selectorRol.selectedIndex].text;
        
        if (!confirm(`¿Está seguro de asociar a "${nombreUsuario}" al cliente "{{ cliente.obtener_nombre_completo }}"?`)) {
            e.preventDefault();
        }
    });

    // Inicializar
    actualizarBotonEnviar();
    
    // Autocompletar algunos permisos de ejemplo basados en el rol
    /*selectorRol.addEventListener('change', function() {
        const textareaPermisos = document.getElementById('id_permisos');
        
        // Solo autocompletar si está vacío
        if (!textareaPermisos.value.trim()) {
            let permisosEjemplo = {};
            
            switch(this.value) {
                case 'PROPIETARIO':
                    permisosEjemplo = {
                        "puede_gestionar_usuarios": true,
                        "puede_ver_todas_transacciones": true,
                        "puede_exportar_reportes": true
                    };
                    break;
                case 'AUTORIZADO':
                    permisosEjemplo = {
                        "puede_ver_transacciones": true,
                        "puede_exportar_transacciones": true
                    };
                    break;
                case 'CONSULTA':
                    permisosEjemplo = {
                        "puede_ver_tasas": true,
                        "puede_ver_saldo": true
                    };
                    break;
            }
            
            if (Object.keys(permisosEjemplo).length > 0) {
                // No autocompletar, solo mostrar que es opcional
                textareaPermisos.placeholder = JSON.stringify(permisosEjemplo, null, 2);
            }
        }
    });*/

    // Verificación periódica del token CSRF (cada 5 minutos)
    setInterval(verificarTokenCSRF, 300000);
});
</script>
{% endblock %}